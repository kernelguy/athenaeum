(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{221:function(t,a,s){"use strict";s.r(a);var e=s(6),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"usage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#usage"}},[t._v("#")]),t._v(" Usage")]),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#obtain-circuit-breaker"}},[t._v("Obtain Circuit Breaker")])]),s("li",[s("a",{attrs:{href:"#attempt"}},[t._v("Attempt")])]),s("li",[s("a",{attrs:{href:"#otherwise-callback"}},[t._v("Otherwise Callback")])]),s("li",[s("a",{attrs:{href:"#retries-failure-threshold"}},[t._v("Retries & Failure Threshold")])]),s("li",[s("a",{attrs:{href:"#recovery-half-open"}},[t._v("Recovery (Half-Open)")])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"obtain-circuit-breaker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#obtain-circuit-breaker"}},[t._v("#")]),t._v(" Obtain Circuit Breaker")]),t._v(" "),s("p",[t._v('Once you have defined your "service" and circuit breaker settings, in your '),s("code",[t._v("configs/circuit-breaker")]),t._v(", you can obtain a "),s("code",[t._v("CircuitBreaker")]),t._v(" instance.\nThis can be done via the "),s("code",[t._v("CircuitBreakerManagerTrait")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[s("span",{pre:!0,attrs:{class:"token php language-php"}},[s("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token package"}},[t._v("Aedart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Circuits"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Traits"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("CircuitBreakerManagerTrait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WeatherService")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token package"}},[t._v("CircuitBreakerManagerTrait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forecast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Obtain circuit breaker for "weather_service" (defined in your')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// configs/circuit-breakers.php file)")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$circuitBreaker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$this")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCircuitBreakerManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'weather_service'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            \n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...remaining not shown")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),s("h2",{attrs:{id:"attempt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attempt"}},[t._v("#")]),t._v(" Attempt")]),t._v(" "),s("p",[t._v("Use the "),s("code",[t._v("attempt()")]),t._v(" method to invoke a callback.\nDepending on your configuration, this callback will be attempted executed one or multiple times ("),s("em",[t._v("See "),s("code",[t._v("retries")]),t._v(" in your configuration file")]),t._v("), until it either succeeds or fails entirely.")]),t._v(" "),s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token package"}},[t._v("Aedart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Contracts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Circuits"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("CircuitBreaker")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$circuitBreaker")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("attempt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CircuitBreaker "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Call 3rd party service, return result ...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$response")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'https://acme.org/api/weather-service/v1/forecast'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$response")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("failed")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'Unable to obtain forecast'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$response")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"otherwise-callback"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#otherwise-callback"}},[t._v("#")]),t._v(" Otherwise Callback")]),t._v(" "),s("p",[t._v("Use the "),s("code",[t._v("$otherwise")]),t._v(" argument to state a callback, which will be invoked if the attempt should fail.")]),t._v(" "),s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token package"}},[t._v("Aedart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Contracts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Circuits"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("CircuitBreaker")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token package"}},[t._v("Acme"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Services"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Weather"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("ServiceUnavailable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$circuitBreaker")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("attempt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CircuitBreaker "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... callback not shown ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CircuitBreaker "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Attempt has failed, do something else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$lastFailure")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cb")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("lastFailure")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$reason")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$lastFailure")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reason")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("empty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$reason")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceUnavailable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$reason")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceUnavailable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'Weather Service is currently unavailable'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("Behind the scenes, if the circuit breaker has detected too many failed attempts, across instances, then the "),s("code",[t._v("$otherwise")]),t._v(" callback can be invoked immidiatly, allowing a "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Fail-fast",target:"_blank",rel:"noopener noreferrer"}},[t._v("fast-failure"),s("OutboundLink")],1),t._v(" to occur.\nThis happens when the "),s("code",[t._v("failure_threshold")]),t._v(" has been reached.")]),t._v(" "),s("h2",{attrs:{id:"retries-failure-threshold"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#retries-failure-threshold"}},[t._v("#")]),t._v(" Retries & Failure Threshold")]),t._v(" "),s("p",[t._v("It is very important to understand that, "),s("strong",[t._v("each failed attempt increases the failure count")]),t._v(".\nThe circuit breaker's internal store keeps track of this failure count, "),s("strong",[t._v("across instances")]),t._v(".\nThis means that, if you have configured your circuit breaker to perform a certain amount "),s("code",[t._v("retries")]),t._v(", it "),s("strong",[t._v("might not actually perform all attempts")]),t._v(", if the "),s("code",[t._v("failure_threshold")]),t._v(" is reached, during those attempts.")]),t._v(" "),s("p",[t._v("Please be mindful og how you choose to configure your "),s("code",[t._v("retries")]),t._v(" and "),s("code",[t._v("failure_threshold")]),t._v(".")]),t._v(" "),s("h2",{attrs:{id:"recovery-half-open"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#recovery-half-open"}},[t._v("#")]),t._v(" Recovery ("),s("em",[t._v("Half-Open")]),t._v(")")]),t._v(" "),s("p",[t._v("When the circuit breaker is in "),s("em",[t._v("Open")]),t._v(" state ("),s("em",[t._v("circuit tripped - failure state")]),t._v("), it will automatically try to switch state to the "),s("em",[t._v("Half-Open")]),t._v(" state, each time "),s("code",[t._v("attempt()")]),t._v(" is invoked.\nHowever, this only happens after the "),s("code",[t._v("grace_period")]),t._v(" has past ("),s("em",[t._v("available in your configuration")]),t._v(").")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Note")]),t._v(" "),s("p",[t._v("By default, only a single circuit breaker instance will be able to obtain the "),s("em",[t._v("Half-Open")]),t._v(" state, across instances.")])]),t._v(" "),s("p",[t._v("If a circuit breaker achieves changing state to "),s("em",[t._v("Half-Open")]),t._v(", it will invoke the provided "),s("code",[t._v("$callback")]),t._v(".\nShould the callback succeed, then "),s("strong",[t._v("the failure count will be reset")]),t._v(", across all instances.\nThis means that the circuit breaker changes its state back to "),s("em",[t._v("Closed")]),t._v(".")]),t._v(" "),s("p",[t._v("If the callback does not succeed, the circuit breaker will remain in "),s("em",[t._v("Open")]),t._v(" state and invoke the "),s("code",[t._v("$otherwise")]),t._v(" callback.")]),t._v(" "),s("p",[t._v("Lastly, if the "),s("em",[t._v("Half-Open")]),t._v(" state cannot be obtained, then the circuit breaker resumes its normal behaviour and invokes the "),s("code",[t._v("$otherwise")]),t._v(" callback.")])])}),[],!1,null,null,null);a.default=n.exports}}]);